{% extends 'layout/base_admin.html' %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css">
<style>
    .metric-card {
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-2px);
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    .activity-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    .activity-icon.sale {
        background-color: rgba(13, 148, 136, 0.1);
        color: #0d9488;
    }
    .activity-icon.stock {
        background-color: rgba(79, 70, 229, 0.1);
        color: #4f46e5;
    }
    .loading {
        opacity: 0.7;
        position: relative;
    }
    .loading::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 24px;
        height: 24px;
        margin: -12px 0 0 -12px;
        border: 2px solid transparent;
        border-top-color: #0d9488;
        border-radius: 50%;
        animation: loading-spinner 0.8s linear infinite;
    }
    @keyframes loading-spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .error-state {
        opacity: 0.5;
        position: relative;
    }
    .error-state::after {
        content: "⚠️";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
    }
</style>
{% endblock %}

{% block content %}
<div class="p-4">
    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Sales Card -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Total Sales (30 Days)</p>
                    <h2 class="text-2xl font-bold" data-kpi="total-sales">₱{{ total_sales|floatformat:2 }}</h2>
                </div>
                <div class="text-right">
                    <p class="text-sm {% if sales_change >= 0 %}text-green-500{% else %}text-red-500{% endif %}" data-kpi="sales-change">
                        {{ sales_change|floatformat:1 }}%
                    </p>
                    <p class="text-xs text-gray-500">vs last month</p>
        </div>
            </div>
            </div>

        <!-- Transactions Card -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Transactions (30 Days)</p>
                    <h2 class="text-2xl font-bold" data-kpi="total-transactions">{{ total_transactions }}</h2>
                </div>
                <div class="text-right">
                    <p class="text-sm {% if transaction_change >= 0 %}text-green-500{% else %}text-red-500{% endif %}" data-kpi="transaction-change">
                        {{ transaction_change|floatformat:1 }}%
                    </p>
                    <p class="text-xs text-gray-500">vs last month</p>
                </div>
                </div>
            </div>

        <!-- Products Card -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Total Products</p>
                    <h2 class="text-2xl font-bold" data-kpi="total-products">{{ total_products }}</h2>
                </div>
                <div class="text-right">
                    <p class="text-sm text-red-500" data-kpi="out-of-stock">{{ out_of_stock }}</p>
                    <p class="text-xs text-gray-500">Out of Stock</p>
                </div>
                </div>
            </div>

        <!-- Users Card -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Total Users</p>
                    <h2 class="text-2xl font-bold" data-kpi="total-users">{{ total_users }}</h2>
                </div>
                <div class="text-right">
                    <p class="text-sm text-green-500" data-kpi="active-users">{{ active_users }}</p>
                    <p class="text-xs text-gray-500">Active Today</p>
                </div>
                    </div>
                </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
        <!-- Sales Trend Chart -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Sales Trend (Last 7 Days)</h3>
            <canvas id="salesChart" class="w-full h-64"></canvas>
        </div>

        <!-- Top Products Chart -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Top Selling Products</h3>
            <canvas id="productsChart" class="w-full h-64"></canvas>
        </div>

        <!-- Category Distribution Chart -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Product Categories</h3>
            <canvas id="categoryChart" class="w-full h-64"></canvas>
        </div>

        <!-- Stock Status Chart -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Stock Status</h3>
            <canvas id="stockChart" class="w-full h-64"></canvas>
        </div>

        <!-- User Activity Chart -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">User Activity (Last 7 Days)</h3>
            <canvas id="userActivityChart" class="w-full h-64"></canvas>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
            <div class="space-y-4" id="recentActivities">
                {% for activity in recent_activities %}
                <div class="flex items-start space-x-3">
                    <span class="material-icons text-gray-500">{{ activity.icon }}</span>
                            <div>
                        <p class="text-sm">{{ activity.description }}</p>
                        <p class="text-xs text-gray-500">{{ activity.timestamp }}</p>
                            </div>
                        </div>
                        {% endfor %}
            </div>
        </div>
    </div>
</div>

    {% endblock %}

    {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // Utility function to create charts
    function createChart(ctx, type, labels, data, options = {}) {
        const defaultOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        };

        const config = {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#3B82F6', // blue-500
                        '#10B981', // green-500
                        '#F59E0B', // yellow-500
                        '#EF4444', // red-500
                        '#8B5CF6', // purple-500
                        '#EC4899', // pink-500
                        '#6366F1', // indigo-500
                        '#14B8A6'  // teal-500
                    ]
                }]
            },
            options: { ...defaultOptions, ...options }
        };

        if (type === 'line') {
            config.data.datasets[0].borderColor = config.data.datasets[0].backgroundColor[0];
            config.data.datasets[0].tension = 0.4;
            config.data.datasets[0].fill = true;
            config.data.datasets[0].backgroundColor = 'rgba(59, 130, 246, 0.1)'; // blue-500 with opacity
        }

        return new Chart(ctx, config);
    }

    // Initialize charts
    let salesChart, productsChart, categoryChart, stockChart, userActivityChart;

    function initializeCharts(data) {
        // Sales Trend Chart
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        salesChart = createChart(salesCtx, 'line', data.sales_labels, data.sales_data, {
                plugins: {
                legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                        callback: value => '₱' + value.toLocaleString()
                    }
                }
            }
        });

        // Top Products Chart
        const productsCtx = document.getElementById('productsChart').getContext('2d');
        productsChart = createChart(productsCtx, 'bar', data.product_labels, data.product_data, {
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        });

        // Category Distribution Chart
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        categoryChart = createChart(categoryCtx, 'doughnut', data.category_labels, data.category_data, {
                plugins: {
                    legend: {
                        position: 'right',
                    labels: {
                        boxWidth: 12
                    }
                }
            }
        });

        // Stock Status Chart
        const stockCtx = document.getElementById('stockChart').getContext('2d');
        stockChart = createChart(stockCtx, 'pie', data.stock_status_labels, data.stock_status_data, {
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12
                    }
                }
            }
        });

        // User Activity Chart
        const userActivityCtx = document.getElementById('userActivityChart').getContext('2d');
        userActivityChart = createChart(userActivityCtx, 'line', data.user_activity_labels, data.user_activity_data, {
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        });
    }

    // Update charts with new data
    function updateCharts(data) {
        // Update Sales Chart
        salesChart.data.labels = data.sales_labels;
        salesChart.data.datasets[0].data = data.sales_data;
        salesChart.update();

        // Update Products Chart
        productsChart.data.labels = data.product_labels;
        productsChart.data.datasets[0].data = data.product_data;
        productsChart.update();

        // Update Category Chart
        categoryChart.data.labels = data.category_labels;
        categoryChart.data.datasets[0].data = data.category_data;
        categoryChart.update();

        // Update Stock Chart
        stockChart.data.labels = data.stock_status_labels;
        stockChart.data.datasets[0].data = data.stock_status_data;
        stockChart.update();

        // Update User Activity Chart
        userActivityChart.data.labels = data.user_activity_labels;
        userActivityChart.data.datasets[0].data = data.user_activity_data;
        userActivityChart.update();

        // Update KPI cards
        document.querySelector('[data-kpi="total-sales"]').textContent = '₱' + data.total_sales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.querySelector('[data-kpi="sales-change"]').textContent = data.sales_change.toFixed(1) + '%';
        document.querySelector('[data-kpi="total-transactions"]').textContent = data.total_transactions;
        document.querySelector('[data-kpi="transaction-change"]').textContent = data.transaction_change.toFixed(1) + '%';
        document.querySelector('[data-kpi="total-products"]').textContent = data.total_products;
        document.querySelector('[data-kpi="out-of-stock"]').textContent = data.out_of_stock;
        document.querySelector('[data-kpi="total-users"]').textContent = data.total_users;
        document.querySelector('[data-kpi="active-users"]').textContent = data.active_users;

        // Update recent activities
        const activitiesContainer = document.getElementById('recentActivities');
        activitiesContainer.innerHTML = data.recent_activities.map(activity => `
            <div class="flex items-start space-x-3">
                <span class="material-icons text-gray-500">${activity.icon}</span>
                <div>
                    <p class="text-sm">${activity.description}</p>
                    <p class="text-xs text-gray-500">${activity.timestamp}</p>
                </div>
            </div>
        `).join('');
    }

    // Initialize charts on page load
    document.addEventListener('DOMContentLoaded', function() {
        const initialData = {
            sales_labels: {{ sales_labels|safe }},
            sales_data: {{ sales_data|safe }},
            product_labels: {{ product_labels|safe }},
            product_data: {{ product_data|safe }},
            category_labels: {{ category_labels|safe }},
            category_data: {{ category_data|safe }},
            stock_status_labels: {{ stock_status_labels|safe }},
            stock_status_data: {{ stock_status_data|safe }},
            user_activity_labels: {{ user_activity_labels|safe }},
            user_activity_data: {{ user_activity_data|safe }}
        };

        // Check if we have data before initializing charts
        if (initialData.sales_labels && initialData.sales_labels.length > 0) {
            initializeCharts(initialData);

            // Refresh data every 30 seconds
            setInterval(function() {
                fetch('{% url "crud:admin_dashboard_data" %}')
                    .then(response => response.json())
                    .then(data => {
                        if (!data.error) {
                            updateCharts(data);
                        }
                    })
                    .catch(error => console.error('Error fetching dashboard data:', error));
            }, 30000);
            } else {
            console.error('No initial data available for charts');
        }
    });
</script>
{% endblock %}